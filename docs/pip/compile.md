```md docs/pip/compile.md (1-158)
# 锁定环境

锁定是指获取一个依赖项，例如 `ruff`，并将其使用的确切版本写入文件。当处理多个依赖项时，锁定确切版本非常有用，以便可以重现环境。如果不锁定，依赖项的版本可能会随着时间的推移、使用不同的工具或跨平台时发生变化。

## 锁定要求

uv 允许以 `requirements.txt` 格式锁定依赖项。建议使用标准的 `pyproject.toml` 来定义依赖项，但也支持其他依赖项格式。有关如何定义依赖项的更多详细信息，请参阅 [声明依赖项](dependencies.md) 的文档。

要锁定在 `pyproject.toml` 中声明的依赖项：

```console
$ uv pip compile pyproject.toml -o requirements.txt
```

请注意，默认情况下 `uv pip compile` 的输出仅显示，需要使用 `--output-file` / `-o` 参数将其写入文件。

要锁定在 `requirements.in` 中声明的依赖项：

```console
$ uv pip compile requirements.in -o requirements.txt
```

要锁定在多个文件中声明的依赖项：

```console
$ uv pip compile pyproject.toml requirements-dev.in -o requirements-dev.txt
```

uv 还支持传统的 `setup.py` 和 `setup.cfg` 格式。要锁定在 `setup.py` 中声明的依赖项：

```console
$ uv pip compile setup.py -o requirements.txt
```

要从 stdin 锁定依赖项，请使用 `-`：

```console
$ echo "ruff" | uv pip compile -
```

要启用可选依赖项进行锁定，例如 "foo" 额外项：

```console
$ uv pip compile pyproject.toml --extra foo
```

要启用所有可选依赖项进行锁定：

```console
$ uv pip compile pyproject.toml --all-extras
```

请注意，`requirements.in` 格式不支持额外项。

## 升级依赖项

当使用输出文件时，uv 会考虑现有输出文件中固定的版本。如果依赖项已固定，则在后续的编译运行中不会升级。例如：

```console
$ echo "ruff==0.3.0" > requirements.txt
$ echo "ruff" | uv pip compile - -o requirements.txt
# This file was autogenerated by uv via the following command:
#    uv pip compile - -o requirements.txt
ruff==0.3.0
```

要升级依赖项，请使用 `--upgrade-package` 标志：

```console
$ uv pip compile - -o requirements.txt --upgrade-package ruff
```

要升级所有依赖项，可以使用 `--upgrade` 标志。

## 同步环境

可以直接从其定义文件或从编译的 `requirements.txt` 文件安装依赖项，使用 `uv pip install`。有关更多详细信息，请参阅 [从文件安装包](packages.md#installing-packages-from-files) 的文档。

使用 `uv pip install` 安装时，除非与 lockfile 冲突，否则不会删除已安装的包。这意味着环境中可能包含未在 lockfile 中声明的依赖项，这对于可重现性并不理想。要确保环境与 lockfile 完全匹配，请改用 `uv pip sync`。

要使用 `requirements.txt` 文件同步环境：

```console
$ uv pip sync requirements.txt
```

要使用 `pyproject.toml` 文件同步环境：

```console
$ uv pip sync pyproject.toml
```

## 添加约束

约束文件是类似于 `requirements.txt` 的文件，仅控制安装的依赖项的 _版本_。但是，在约束文件中包含一个包不会触发该包的安装。约束可用于为不是当前项目依赖项的依赖项添加限制。

要定义约束，请为包定义一个限制：

```python title="constraints.txt"
pydantic<2.0
```

要使用约束文件：

```console
$ uv pip compile requirements.in --constraint constraints.txt
```

请注意，每个文件中可以定义多个约束，并且可以使用多个文件。

## 覆盖依赖项版本

覆盖文件是类似于 `requirements.txt` 的文件，强制安装特定版本的依赖项，无论任何组成包声明的需求如何，也不管这是否会被视为无效的解析。

虽然约束是 _附加的_，因为它们与组成包的需求相结合，但覆盖是 _绝对的_，因为它们完全替换了组成包的需求。

覆盖最常用于删除传递依赖项的上限。例如，如果 `a` 需要 `c>=1.0,<2.0` 且 `b` 需要 `c>=2.0`，而当前项目需要 `a` 和 `b`，则无法解析依赖项。

要定义覆盖，请为有问题的包定义新的需求：

```python title="overrides.txt"
c>=2.0
```

要使用覆盖文件：

```console
$ uv pip compile requirements.in --override overrides.txt
```

现在，解析可以成功。但是，请注意，如果 `a` _正确_ 地不支持 `c>=2.0`，则在使用包时可能会遇到运行时错误。

请注意，每个文件中可以定义多个覆盖，并且可以使用多个文件。
```